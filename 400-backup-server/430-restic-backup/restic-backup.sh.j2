#!/bin/bash
set -e

# Load .env variables
if [[ -f /etc/restic/.env ]]; then
  source /etc/restic/.env
else
  echo "Error: .env file not found at /etc/restic/.env" >&2
  exit 1
fi

# Log start
logger "Starting Restic backup of {{ backup_source }}"

# Run backup
restic backup {{ backup_source }} \
  --verbose \
  --exclude-caches \
  --exclude='*.tmp' \
  --exclude='*.temp' \
  --exclude='lost+found' 2>&1 | logger -t restic-backup

# Log completion
logger "Restic backup completed successfully"

# Send ntfy notification if webhook is set
if [[ -n "$KATANA_NTFY_WEBHOOK" ]]; then
  curl -H "Title: Restic Backup" -d "Backup completed successfully on $(hostname) at $(date)" "$KATANA_NTFY_WEBHOOK"
fi
