/var/log/rclone-sync-restic.log {
  missingok
  notifempty
  daily
  rotate 90
  compress
  delaycompress
  dateext
  create 0640 root adm
  copytruncate

  postrotate
    # keep total size (current + rotated) <= 1 GiB
    LIMIT=1073741824
    BASE="/var/log/rclone-sync-restic.log"

    # list rotated files (exclude the current log), oldest first
    tmp=$(mktemp) || exit 0
    find /var/log -maxdepth 1 -type f -name 'rclone-sync-restic.log*' ! -name 'rclone-sync-restic.log' -printf '%T@ %p\n' | sort -n > "$tmp"

    # compute total size (includes current and rotated)
    total=$(find /var/log -maxdepth 1 -type f -name 'rclone-sync-restic.log*' -printf '%s\n' | awk '{s+=$1} END{print s+0}')

    if [ "$total" -le "$LIMIT" ]; then
      rm -f "$tmp"
      exit 0
    fi

    while read -r line; do
      file=$(printf "%s" "$line" | cut -d' ' -f2-)
      [ -f "$file" ] || continue
      size=$(stat -c%s "$file" 2>/dev/null || echo 0)
      rm -f "$file"
      total=$((total - size))
      [ "$total" -le "$LIMIT" ] && break
    done < "$tmp"

    rm -f "$tmp"
  endscript
}