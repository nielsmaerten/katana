#!/bin/bash
set -e

# Load .env variables
if [[ -f /etc/restic/.env ]]; then
  source /etc/restic/.env
else
  echo "Error: .env file not found at /etc/restic/.env" >&2
  exit 1
fi

# Log start
logger "Starting Restic cleanup"

# Forget old snapshots (keep 14 days)
restic forget \
  --keep-daily 14 \
  --prune \
  --verbose 2>&1 | logger -t restic-cleanup

# Check repository consistency
restic check 2>&1 | logger -t restic-cleanup

# Log completion
logger "Restic cleanup completed successfully"

# Send ntfy notification if webhook is set
if [[ -n "$KATANA_NTFY_WEBHOOK" ]]; then
  curl -H "Title: Restic Cleanup" -d "Cleanup completed successfully on $(hostname) at $(date)" "$KATANA_NTFY_WEBHOOK"
fi
