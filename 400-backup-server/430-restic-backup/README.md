# Off-site backups

If you've completed steps 410 and 420, you'll now have local backups on a ZFS mirror. A great start, but to fully implement the 3-2-1 rule, we need to store backups in a separate geographical location as well.

Let's do that next.

## Assumptions

- PBS datastore at `/tank/pbs-datastore`
- Optional additional ZFS datasets under `/tank/*`
- You have a cloud backup location compatible with rclone
  - I recommend using an S3-compatible provider
  - They're generally cheap, fast and well-supported by rclone
  - Beware of egress fees!

## Ansible playbook

The Ansible playbook `playbook.yml` is meant to run on the Proxmox host. It will:

1. Install Restic, Rclone and Resticprofile
1. Deploy an example rclone.conf file (if none exists yet)
1. Deploy recommended resticprofiles (if none exist yet)
1. Schedule resticprofiles to run at their defined intervals

### Package: rclone 

#### rclone.conf
- Configured with an S3 backends as an example
- Update this file with your own backend(s)

#### rclone serve restic
- A service will be created to serve `/tank/restic` as a Restic REST server over port 8111
- Other machines/guests can now use this server as a target for their own backups

#### rclone cron job
- Sync `/tank/restic` to an off-site rclone backend every night
- Uses a lock to prevent duplicate processes

### Package: resticprofile
- We'll deploy a profile for every dataset in `/tank`, except `/tank/restic`, since that's handled by the rclone cron job
- Retention settings and backup interval can be configured per profile

## Example resticprofiles

### paperless.yml
- `/tank/paperless` => `rclone:s3:paperless`
- runs daily
- keep 7 daily, 8 weekly, 12 monthly
- prunes & forgets automatically
- checks 10% of repo every day
- checks 100% of repo every quarter

### pbs.yml
- `/tank/pbs-datastore` => `rclone:s3:pbs-datastore`
- runs daily
- keep 7 daily
- no extensive retention, because PBS handles this itself
- checks 10% of repo every day
- checks 50% of repo every quarter


## Security
- restic repository password is stored in /root/.restic-password.txt
- randomly generated by Ansible if not present yet